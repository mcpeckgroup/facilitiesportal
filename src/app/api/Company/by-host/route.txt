import { NextRequest } from "next/server";
import { createClient } from "@supabase/supabase-js";

export const dynamic = "force-dynamic";
export const runtime = "nodejs";

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export async function GET(req: NextRequest) {
  try {
    const search = req.nextUrl.searchParams;
    const explicitSlug = search.get("slug");

    // Prefer explicit ?slug= for dev/local/manual override
    let slug = explicitSlug?.toLowerCase() || "";

    if (!slug) {
      const host = (req.headers.get("x-app-host") || req.headers.get("host") || "").toLowerCase();
      const parts = host.split(".");
      if (parts.length >= 3) {
        slug = parts[0] === "www" ? parts[1] : parts[0];
      }
    }

    // Optional default (you can remove this to force 400 instead)
    if (!slug) {
      slug = "pharmetric";
    }

    const supabase = createClient(supabaseUrl, supabaseAnon);
    const { data, error } = await supabase
      .from("companies")
      .select("id, slug, name")
      .eq("slug", slug)
      .single();

    if (error || !data) {
      return new Response(`Company not found for slug "${slug}"`, { status: 404 });
    }

    return new Response(JSON.stringify(data), { status: 200 });
  } catch (e: any) {
    return new Response(String(e?.message || e), { status: 500 });
  }
}
